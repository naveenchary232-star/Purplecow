import React, { useState, useEffect } from 'react';
import { Package, Truck, CheckCircle, Calendar, User, Phone, MapPin, Plus, Search, Copy, FileText, X, ClipboardList } from 'lucide-react';

export default function LaundryTracker() {
  const [customers, setCustomers] = useState([]);
  const [runsheets, setRunsheets] = useState([]);
  const [showAddCustomer, setShowAddCustomer] = useState(false);
  const [showRunsheetDashboard, setShowRunsheetDashboard] = useState(false);
  const [showAddRunsheet, setShowAddRunsheet] = useState(false);
  const [selectedRunsheet, setSelectedRunsheet] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [copiedCode, setCopiedCode] = useState(null);
  const [newCustomer, setNewCustomer] = useState({
    name: '',
    phone: '',
    address: '',
    plan: '2699',
    startDate: new Date().toISOString().split('T')[0]
  });
  const [newRunsheet, setNewRunsheet] = useState({
    riderName: '',
    riderPhone: '',
    type: 'pickup',
    selectedOrders: []
  });

  // Load data from localStorage on mount
  useEffect(() => {
    const savedCustomers = localStorage.getItem('laundry-customers');
    const savedRunsheets = localStorage.getItem('laundry-runsheets');
    
    if (savedCustomers) {
      try {
        setCustomers(JSON.parse(savedCustomers));
      } catch (error) {
        console.error('Failed to load customers:', error);
      }
    }
    
    if (savedRunsheets) {
      try {
        setRunsheets(JSON.parse(savedRunsheets));
      } catch (error) {
        console.error('Failed to load runsheets:', error);
      }
    }
  }, []);

  // Save customers to localStorage
  useEffect(() => {
    if (customers.length > 0) {
      localStorage.setItem('laundry-customers', JSON.stringify(customers));
    }
  }, [customers]);

  // Save runsheets to localStorage
  useEffect(() => {
    if (runsheets.length > 0) {
      localStorage.setItem('laundry-runsheets', JSON.stringify(runsheets));
    }
  }, [runsheets]);

  const generateCode = () => {
    return Math.floor(1000 + Math.random() * 9000).toString();
  };

  const sendWhatsAppNotification = (phone, customerName, washNumber, type, code, completedWashes) => {
    navigator.clipboard.writeText(code).then(() => {
      setCopiedCode(code);
      setTimeout(() => setCopiedCode(null), 2000);
    }).catch(err => {
      console.error('Failed to copy:', err);
    });
    
    let cleanPhone = phone.replace(/[^0-9]/g, '');
    
    if (!cleanPhone.startsWith('91') && cleanPhone.length === 10) {
      cleanPhone = '91' + cleanPhone;
    }
    
    const currentDate = new Date().toLocaleDateString('en-IN', { 
      day: '2-digit', 
      month: '2-digit', 
      year: 'numeric' 
    });
    
    let message = '';
    if (type === 'pickup') {
      message = `âœ¨ *PURPLE COW LAUNDRY* ğŸ„ğŸ’œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ‘‹ Hello *${customerName}*!

ğŸ“¦ *PICKUP CONFIRMED!* âœ…

ğŸ”¢ *Order ID:* #${code}
ğŸ§º *Wash Number:* ${washNumber}/10
ğŸ“Š *Progress:* ${completedWashes}/10 Completed
ğŸ“… *Date:* ${currentDate}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ¨ Your clothes are now in our care!
ğŸ§¼ Premium wash & dry service
â° We'll notify you for delivery

ğŸ’¡ *Track your order with ID:* #${code}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ™ Thank you for choosing Purple Cow!
ğŸš€ India's Most Trusted Laundry Service`;
    } else if (type === 'delivery') {
      const remainingWashes = 10 - completedWashes;
      const completionBonus = completedWashes === 10 
        ? `ğŸŠ *CONGRATULATIONS!* All 10 washes completed! ğŸŠ

` 
        : `ğŸ’¡ *Remaining washes:* ${remainingWashes} more to go!

`;
      
      message = `âœ¨ *PURPLE COW LAUNDRY* ğŸ„ğŸ’œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ‘‹ Hello *${customerName}*!

ğŸ‰ *DELIVERY COMPLETED!* âœ…

ğŸ”¢ *Order ID:* #${code}
ğŸ§º *Wash Number:* ${washNumber}/10
ğŸ“Š *Progress:* ${completedWashes}/10 Completed
ğŸ“… *Delivered:* ${currentDate}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ¨ Your fresh, clean laundry is delivered!
ğŸ‘• Washed, dried & neatly folded
ğŸ˜Š Hope you love our service

${completionBonus}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ™ Thank you for trusting Purple Cow!
ğŸ“ Call us anytime for next pickup!`;
    }
    
    const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
  };

  const addCustomer = () => {
    if (newCustomer.name && newCustomer.phone) {
      const customer = {
        id: Date.now(),
        ...newCustomer,
        washes: Array(10).fill(null).map((_, i) => ({
          washNumber: i + 1,
          status: 'pending',
          pickupDate: null,
          deliveryDate: null,
          pickupCode: null,
          deliveryCode: null
        }))
      };
      setCustomers([...customers, customer]);
      setNewCustomer({
        name: '',
        phone: '',
        address: '',
        plan: '2699',
        startDate: new Date().toISOString().split('T')[0]
      });
      setShowAddCustomer(false);
    }
  };

  const updateWashStatus = (customerId, washNumber, status, dateType = null) => {
    setCustomers(customers.map(customer => {
      if (customer.id === customerId) {
        const updatedWashes = customer.washes.map(wash => {
          if (wash.washNumber === washNumber) {
            const updatedWash = { ...wash, status };
            if (dateType === 'pickup' && status === 'picked-up') {
              updatedWash.pickupDate = new Date().toISOString().split('T')[0];
              updatedWash.pickupCode = generateCode();
              const completedCount = customer.washes.filter(w => w.status === 'delivered').length;
              setTimeout(() => {
                sendWhatsAppNotification(customer.phone, customer.name, washNumber, 'pickup', updatedWash.pickupCode, completedCount);
              }, 100);
            } else if (dateType === 'delivery' && status === 'delivered') {
              updatedWash.deliveryDate = new Date().toISOString().split('T')[0];
              updatedWash.deliveryCode = generateCode();
              const completedCount = customer.washes.filter(w => w.status === 'delivered').length + 1;
              setTimeout(() => {
                sendWhatsAppNotification(customer.phone, customer.name, washNumber, 'delivery', updatedWash.deliveryCode, completedCount);
              }, 100);
            }
            return updatedWash;
          }
          return wash;
        });
        return { ...customer, washes: updatedWashes };
      }
      return customer;
    }));
  };

  const deleteCustomer = (customerId) => {
    if (confirm('Are you sure you want to delete this customer?')) {
      setCustomers(customers.filter(c => c.id !== customerId));
    }
  };

  const getPendingOrders = (type) => {
    const orders = [];
    customers.forEach(customer => {
      customer.washes.forEach(wash => {
        if (type === 'pickup' && wash.status === 'pending') {
          orders.push({
            customerId: customer.id,
            customerName: customer.name,
            customerPhone: customer.phone,
            customerAddress: customer.address,
            washNumber: wash.washNumber,
            washId: `${customer.id}-${wash.washNumber}`,
            type: 'pickup'
          });
        } else if (type === 'delivery' && wash.status === 'picked-up') {
          orders.push({
            customerId: customer.id,
            customerName: customer.name,
            customerPhone: customer.phone,
            customerAddress: customer.address,
            washNumber: wash.washNumber,
            washId: `${customer.id}-${wash.washNumber}`,
            pickupCode: wash.pickupCode,
            type: 'delivery'
          });
        }
      });
    });
    return orders;
  };

  const createRunsheet = () => {
    if (newRunsheet.riderName && newRunsheet.riderPhone && newRunsheet.selectedOrders.length > 0) {
      const runsheet = {
        id: Date.now(),
        runsheetId: `RS${Date.now().toString().slice(-6)}`,
        date: new Date().toISOString().split('T')[0],
        riderName: newRunsheet.riderName,
        riderPhone: newRunsheet.riderPhone,
        type: newRunsheet.type,
        orders: newRunsheet.selectedOrders.map(orderId => {
          const order = getPendingOrders(newRunsheet.type).find(o => o.washId === orderId);
          return {
            ...order,
            completed: false,
            completedAt: null
          };
        }),
        status: 'active',
        createdAt: new Date().toISOString(),
        closedAt: null
      };
      
      setRunsheets([...runsheets, runsheet]);
      setNewRunsheet({
        riderName: '',
        riderPhone: '',
        type: 'pickup',
        selectedOrders: []
      });
      setShowAddRunsheet(false);
    }
  };

  const toggleOrderSelection = (orderId) => {
    setNewRunsheet(prev => ({
      ...prev,
      selectedOrders: prev.selectedOrders.includes(orderId)
        ? prev.selectedOrders.filter(id => id !== orderId)
        : [...prev.selectedOrders, orderId]
    }));
  };

  const markOrderComplete = (runsheetId, orderWashId) => {
    setRunsheets(runsheets.map(runsheet => {
      if (runsheet.id === runsheetId) {
        return {
          ...runsheet,
          orders: runsheet.orders.map(order => {
            if (order.washId === orderWashId) {
              return {
                ...order,
                completed: true,
                completedAt: new Date().toISOString()
              };
            }
            return order;
          })
        };
      }
      return runsheet;
    }));
  };

  const closeRunsheet = (runsheetId) => {
    const runsheet = runsheets.find(r => r.id === runsheetId);
    const allCompleted = runsheet.orders.every(o => o.completed);
    
    if (!allCompleted) {
      if (!confirm('Not all orders are completed. Are you sure you want to close this runsheet?')) {
        return;
      }
    }
    
    if (confirm('Close this runsheet? This action cannot be undone.')) {
      setRunsheets(runsheets.map(r => {
        if (r.id === runsheetId) {
          // Update wash statuses based on runsheet type
          r.orders.forEach(order => {
            if (order.completed) {
              if (r.type === 'pickup') {
                updateWashStatus(order.customerId, order.washNumber, 'picked-up', 'pickup');
              } else if (r.type === 'delivery') {
                updateWashStatus(order.customerId, order.washNumber, 'delivered', 'delivery');
              }
            }
          });
          
          return {
            ...r,
            status: 'closed',
            closedAt: new Date().toISOString()
          };
        }
        return r;
      }));
      setSelectedRunsheet(null);
    }
  };

  const getRunsheetProgress = (runsheet) => {
    const completed = runsheet.orders.filter(o => o.completed).length;
    const total = runsheet.orders.length;
    return { completed, total, percentage: (completed / total) * 100 };
  };

  const getStatusColor = (status) => {
    switch (status) {
      case 'pending': return 'bg-gray-200 text-gray-700';
      case 'picked-up': return 'bg-blue-500 text-white';
      case 'delivered': return 'bg-green-500 text-white';
      default: return 'bg-gray-200 text-gray-700';
    }
  };

  const getCompletedWashes = (customer) => {
    return customer.washes.filter(w => w.status === 'delivered').length;
  };

  const filteredCustomers = customers.filter(customer =>
    customer.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
    customer.phone.includes(searchTerm)
  );

  const activeRunsheets = runsheets.filter(r => r.status === 'active');
  const completedRunsheets = runsheets.filter(r => r.status === 'closed').slice(-4).reverse();

  // Runsheet Dashboard View
  if (showRunsheetDashboard && !selectedRunsheet) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 p-4">
        <div className="max-w-7xl mx-auto">
          <div className="bg-gray-800 rounded-lg shadow-2xl p-6 mb-6 border border-purple-500/30">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h1 className="text-3xl font-bold text-purple-400 flex items-center gap-2">
                  ğŸ“Š Runsheet Dashboard
                </h1>
                <p className="text-gray-300 mt-1">Manage pickup and delivery runsheets</p>
              </div>
              <div className="flex gap-3">
                <button
                  onClick={() => setShowAddRunsheet(true)}
                  className="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg flex items-center gap-2 transition shadow-lg"
                >
                  <Plus size={20} />
                  New Runsheet
                </button>
                <button
                  onClick={() => setShowRunsheetDashboard(false)}
                  className="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg flex items-center gap-2 transition shadow-lg"
                >
                  <X size={20} />
                  Close
                </button>
              </div>
            </div>
          </div>

          {/* Add Runsheet Form */}
          {showAddRunsheet && (
            <div className="bg-gray-800 rounded-lg shadow-2xl p-6 mb-6 border border-purple-500/30">
              <h2 className="text-xl font-bold text-purple-400 mb-4">Create New Runsheet</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-2">
                    <User size={16} className="inline mr-1" />
                    Rider Name *
                  </label>
                  <input
                    type="text"
                    value={newRunsheet.riderName}
                    onChange={(e) => setNewRunsheet({ ...newRunsheet, riderName: e.target.value })}
                    className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 text-white"
                    placeholder="Enter rider name"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-300 mb-2">
                    <Phone size={16} className="inline mr-1" />
                    Rider Phone *
                  </label>
                  <input
                    type="tel"
                    value={newRunsheet.riderPhone}
                    onChange={(e) => setNewRunsheet({ ...newRunsheet, riderPhone: e.target.value })}
                    className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 text-white"
                    placeholder="Enter phone"
                  />
                </div>
              </div>

              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-300 mb-2">Type *</label>
                <div className="flex gap-4">
                  <button
                    onClick={() => setNewRunsheet({ ...newRunsheet, type: 'pickup', selectedOrders: [] })}
                    className={`flex-1 py-3 rounded-lg font-semibold transition ${
                      newRunsheet.type === 'pickup'
                        ? 'bg-blue-600 text-white'
                        : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                    }`}
                  >
                    ğŸ“¦ Pickup
                  </button>
                  <button
                    onClick={() => setNewRunsheet({ ...newRunsheet, type: 'delivery', selectedOrders: [] })}
                    className={`flex-1 py-3 rounded-lg font-semibold transition ${
                      newRunsheet.type === 'delivery'
                        ? 'bg-green-600 text-white'
                        : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
                    }`}
                  >
                    ğŸšš Delivery
                  </button>
                </div>
              </div>

              <div className="mb-4">
                <label className="block text-sm font-medium text-gray-300 mb-2">
                  Select Orders ({newRunsheet.selectedOrders.length} selected)
                </label>
                <div className="max-h-96 overflow-y-auto bg-gray-700 rounded-lg p-4 space-y-2">
                  {getPendingOrders(newRunsheet.type).length === 0 ? (
                    <p className="text-gray-400 text-center py-4">No pending {newRunsheet.type} orders available</p>
                  ) : (
                    getPendingOrders(newRunsheet.type).map(order => (
                      <div
                        key={order.washId}
                        onClick={() => toggleOrderSelection(order.washId)}
                        className={`p-3 rounded-lg cursor-pointer transition ${
                          newRunsheet.selectedOrders.includes(order.washId)
                            ? 'bg-purple-600 text-white'
                            : 'bg-gray-600 text-gray-200 hover:bg-gray-500'
                        }`}
                      >
                        <div className="flex items-center justify-between">
                          <div>
                            <div className="font-semibold">{order.customerName}</div>
                            <div className="text-sm opacity-90">Wash #{order.washNumber} â€¢ {order.customerPhone}</div>
                            {order.customerAddress && (
                              <div className="text-xs opacity-75 mt-1">ğŸ“ {order.customerAddress}</div>
                            )}
                          </div>
                          <div className="text-2xl">
                            {newRunsheet.selectedOrders.includes(order.washId) ? 'â˜‘ï¸' : 'â¬œ'}
                          </div>
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>

              <div className="flex gap-3">
                <button
                  onClick={createRunsheet}
                  disabled={!newRunsheet.riderName || !newRunsheet.riderPhone || newRunsheet.selectedOrders.length === 0}
                  className="bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white px-6 py-2 rounded-lg transition shadow-lg"
                >
                  Create Runsheet
                </button>
                <button
                  onClick={() => setShowAddRunsheet(false)}
                  className="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg transition"
                >
                  Cancel
                </button>
              </div>
            </div>
          )}

          {/* Active Runsheets */}
          <div className="mb-8">
            <h2 className="text-2xl font-bold text-purple-400 mb-4">Active Runsheets ({activeRunsheets.length})</h2>
            {activeRunsheets.length === 0 ? (
              <div className="bg-gray-800 rounded-lg p-8 text-center border border-purple-500/30">
                <ClipboardList size={48} className="mx-auto text-gray-600 mb-3" />
                <p className="text-gray-400">No active runsheets. Create one to get started!</p>
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {activeRunsheets.map(runsheet => {
                  const progress = getRunsheetProgress(runsheet);
                  return (
                    <div
                      key={runsheet.id}
                      onClick={() => setSelectedRunsheet(runsheet)}
                      className="bg-gray-800 rounded-lg p-6 border border-purple-500/30 cursor-pointer hover:border-purple-400 transition shadow-lg"
                    >
                      <div className="flex items-start justify-between mb-3">
                        <div>
                          <div className="text-xl font-bold text-purple-400">#{runsheet.runsheetId}</div>
                          <div className="text-gray-300 text-sm">ğŸ“… {runsheet.date}</div>
                        </div>
                        <div className={`px-3 py-1 rounded-lg font-semibold text-sm ${
                          runsheet.type === 'pickup' ? 'bg-blue-600 text-white' : 'bg-green-600 text-white'
                        }`}>
                          {runsheet.type === 'pickup' ? 'ğŸ“¦ PICKUP' : 'ğŸšš DELIVERY'}
                        </div>
                      </div>

                      <div className="mb-3">
                        <div className="text-gray-300 font-semibold">{runsheet.riderName}</div>
                        <div className="text-gray-400 text-sm">ğŸ“ {runsheet.riderPhone}</div>
                      </div>

                      <div className="mb-3">
                        <div className="flex justify-between text-sm text-gray-300 mb-2">
                          <span>Progress</span>
                          <span className="font-semibold">{progress.completed}/{progress.total} orders</span>
                        </div>
                        <div className="w-full bg-gray-700 rounded-full h-2">
                          <div
                            className="bg-gradient-to-r from-purple-500 to-blue-500 h-2 rounded-full transition-all duration-500"
                            style={{ width: `${progress.percentage}%` }}
                          />
                        </div>
                      </div>

                      <div className="text-center text-2xl font-bold text-purple-400">
                        {progress.percentage.toFixed(0)}% Complete
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>

          {/* Completed Runsheets */}
          <div>
            <h2 className="text-2xl font-bold text-gray-400 mb-4">Recently Completed ({completedRunsheets.length})</h2>
            {completedRunsheets.length === 0 ? (
              <div className="bg-gray-800 rounded-lg p-8 text-center border border-gray-700">
                <CheckCircle size={48} className="mx-auto text-gray-600 mb-3" />
                <p className="text-gray-400">No completed runsheets yet</p>
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {completedRunsheets.map(runsheet => {
                  const progress = getRunsheetProgress(runsheet);
                  return (
                    <div
                      key={runsheet.id}
                      onClick={() => setSelectedRunsheet(runsheet)}
                      className="bg-gray-800 rounded-lg p-6 border border-gray-700 cursor-pointer hover:border-gray-600 transition opacity-75"
                    >
                      <div className="flex items-start justify-between mb-3">
                        <div>
                          <div className="text-xl font-bold text-gray-400">#{runsheet.runsheetId}</div>
                          <div className="text-gray-500 text-sm">ğŸ“… {runsheet.date}</div>
                        </div>
                        <div className="bg-gray-600 text-gray-300 px-3 py-1 rounded-lg font-semibold text-sm">
                          ğŸ”’ CLOSED
                        </div>
                      </div>

                      <div className="mb-3">
                        <div className="text-gray-400 font-semibold">{runsheet.riderName}</div>
                        <div className="text-gray-500 text-sm">
                          {progress.completed}/{progress.total} orders completed
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      </div>
    );
  }

  // Detailed Runsheet View
  if (selectedRunsheet) {
    const progress = getRunsheetProgress(selectedRunsheet);
    const isActive = selectedRunsheet.status === 'active';

    return (
      <div className="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 p-4">
        <div className="max-w-7xl mx-auto">
          <div className="bg-gray-800 rounded-lg shadow-2xl p-6 mb-6 border border-purple-500/30">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h1 className="text-3xl font-bold text-purple-400 flex items-center gap-2">
                  #{selectedRunsheet.runsheetId}
                  {!isActive && <span className="text-gray-400 text-xl ml-2">ğŸ”’ CLOSED</span>}
                </h1>
                <p className="text-gray-300 mt-1">
                  {selectedRunsheet.type === 'pickup' ? 'ğŸ“¦ Pickup' : 'ğŸšš Delivery'} Runsheet â€¢ {selectedRunsheet.date}
                </p>
              </div>
              <button
                onClick={() => setSelectedRunsheet(null)}
                className="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg flex items-center gap-2 transition shadow-lg"
              >
                <X size={20} />
                Back
              </button>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
              <div className="bg-gray-700 rounded-lg p-4">
                <div className="text-gray-400 text-sm mb-1">Rider</div>
                <div className="text-white font-semibold">{selectedRunsheet.riderName}</div>
                <div className="text-gray-300 text-sm">ğŸ“ {selectedRunsheet.riderPhone}</div>
              </div>
              <div className="bg-gray-700 rounded-lg p-4">
                <div className="text-gray-400 text-sm mb-1">Progress</div>
                <div className="text-white font-bold text-2xl">{progress.completed}/{progress.total}</div>
                <div className="text-gray-300 text-sm">{progress.percentage.toFixed(0)}% Complete</div>
              </div>
              <div className="bg-gray-700 rounded-lg p-4">
                <div className="text-gray-400 text-sm mb-1">Status</div>
                <div className={`font-bold text-xl ${isActive ? 'text-green-400' : 'text-gray-400'}`}>
                  {isActive ? 'âœ… ACTIVE' : 'ğŸ”’ CLOSED'}
                </div>
              </div>
            </div>

            <div className="w-full bg-gray-700 rounded-full h-3 mb-4">
              <div
                className="bg-gradient-to-r from-purple-500 to-blue-500 h-3 rounded-full transition-all duration-500"
                style={{ width: `${progress.percentage}%` }}
              />
            </div>

            {isActive && (
              <button
                onClick={() => closeRunsheet(selectedRunsheet.id)}
                className="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition shadow-lg"
              >
                ğŸ”’ Close Runsheet
              </button>
            )}
          </div>

          <div className="space-y-4">
            {selectedRunsheet.orders.map((order, index) => (
              <div
                key={order.washId}
                className={`bg-gray-800 rounded-lg p-6 border transition shadow-lg ${
                  order.completed
                    ? 'border-green-500/50 bg-gray-800/50'
                    : 'border-purple-500/30'
                }`}
              >
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <div className="flex items-center gap-3 mb-2">
                      <div className="text-2xl font-bold text-purple-400">#{index + 1}</div>
                      <div>
                        <div className="text-xl font-semibold text-white">{order.customerName}</div>
                        <div className="text-gray-400 text-sm">Wash #{order.washNumber}</div>
                      </div>
                      {order.completed && (
                        <div className="bg-green-600 text-white px-3 py-1 rounded-lg font-bold text-sm ml-auto">
                          âœ“ DONE
                        </div>
                      )}
                    </div>
                    <div className="text-gray-300 mb-2">ğŸ“ {order.customerPhone}</div>
                    {order.customerAddress && (
                      <div className="flex items-center gap-2 mb-2">
                        <MapPin size={16} className="text-gray-400" />
                        <span className="text-gray-300">{order.customerAddress}</span>
                        <a
                          href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(order.customerAddress)}`}
                          target="_blank"
                          rel="noopener noreferrer"
                          onClick={(e) => e.stopPropagation()}
                          className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs transition shadow-lg"
                        >
                          ğŸ—ºï¸ Navigate
                        </a>
                      </div>
                    )}
                    {order.completed && order.completedAt && (
                      <div className="text-green-400 text-sm">
                        âœ“ Completed at {new Date(order.completedAt).toLocaleString('en-IN')}
                      </div>
                    )}
                  </div>
                  {isActive && !order.completed && (
                    <button
                      onClick={() => markOrderComplete(selectedRunsheet.id, order.washId)}
                      className="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition shadow-lg flex items-center gap-2"
                    >
                      <CheckCircle size={20} />
                      Mark Done
                    </button>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    );
  }

  // Main Customer Dashboard
  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 p-4">
      {copiedCode && (
        <div className="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 z-50 animate-bounce">
          <Copy size={20} />
          <span className="font-semibold">Order ID #{copiedCode} Copied!</span>
        </div>
      )}
      
      <div className="max-w-7xl mx-auto">
        <div className="bg-gray-800 rounded-lg shadow-2xl p-6 mb-6 border border-purple-500/30">
          <div className="flex items-center justify-between mb-4">
            <div>
              <h1 className="text-3xl font-bold text-purple-400 flex items-center gap-2">
                ğŸ„ğŸ’œ Purple Cow Laundry Tracker
              </h1>
              <p className="text-gray-300 mt-1">Track pickup, delivery & 10-wash completion</p>
            </div>
            <div className="flex gap-3">
              <button
                onClick={() => setShowRunsheetDashboard(true)}
                className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg flex items-center gap-2 transition shadow-lg"
              >
                <FileText size={20} />
                ğŸ“Š Runsheets
              </button>
              <button
                onClick={() => setShowAddCustomer(!showAddCustomer)}
                className="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg flex items-center gap-2 transition shadow-lg"
              >
                <Plus size={20} />
                Add Customer
              </button>
            </div>
          </div>

          <div className="relative">
            <Search className="absolute left-3 top-3 text-gray-400" size={20} />
            <input
              type="text"
              placeholder="Search by name or phone..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full pl-10 pr-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-white placeholder-gray-400"
            />
          </div>
        </div>

        {showAddCustomer && (
          <div className="bg-gray-800 rounded-lg shadow-2xl p-6 mb-6 border border-purple-500/30">
            <h2 className="text-xl font-bold text-purple-400 mb-4">Add New Customer</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">
                  <User size={16} className="inline mr-1" />
                  Customer Name *
                </label>
                <input
                  type="text"
                  value={newCustomer.name}
                  onChange={(e) => setNewCustomer({ ...newCustomer, name: e.target.value })}
                  className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 text-white placeholder-gray-400"
                  placeholder="Enter name"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">
                  <Phone size={16} className="inline mr-1" />
                  Phone Number *
                </label>
                <input
                  type="tel"
                  value={newCustomer.phone}
                  onChange={(e) => setNewCustomer({ ...newCustomer, phone: e.target.value })}
                  className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 text-white placeholder-gray-400"
                  placeholder="Enter phone"
                />
              </div>
              <div className="md:col-span-2">
                <label className="block text-sm font-medium text-gray-300 mb-2">
                  <MapPin size={16} className="inline mr-1" />
                  Address
                </label>
                <input
                  type="text"
                  value={newCustomer.address}
                  onChange={(e) => setNewCustomer({ ...newCustomer, address: e.target.value })}
                  className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 text-white placeholder-gray-400"
                  placeholder="Enter full address for Google Maps"
                />
                <p className="text-xs text-gray-400 mt-1">ğŸ’¡ Tip: Include area, landmark, and pincode for accurate navigation</p>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">
                  <Calendar size={16} className="inline mr-1" />
                  Start Date
                </label>
                <input
                  type="date"
                  value={newCustomer.startDate}
                  onChange={(e) => setNewCustomer({ ...newCustomer, startDate: e.target.value })}
                  className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 text-white"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">Plan</label>
                <input
                  type="text"
                  value={`â‚¹${newCustomer.plan}/-`}
                  disabled
                  className="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-900 text-gray-300"
                />
              </div>
            </div>
            <div className="flex gap-3 mt-4">
              <button
                onClick={addCustomer}
                className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition shadow-lg"
              >
                Save Customer
              </button>
              <button
                onClick={() => setShowAddCustomer(false)}
                className="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg transition"
              >
                Cancel
              </button>
            </div>
          </div>
        )}

        {filteredCustomers.length === 0 ? (
          <div className="bg-gray-800 rounded-lg shadow-2xl p-12 text-center border border-purple-500/30">
            <Package size={64} className="mx-auto text-gray-600 mb-4" />
            <h3 className="text-xl font-semibold text-gray-300 mb-2">No Customers Yet</h3>
            <p className="text-gray-400">Click "Add Customer" to get started!</p>
          </div>
        ) : (
          <div className="space-y-6">
            {filteredCustomers.map(customer => {
              const completedWashes = getCompletedWashes(customer);
              const progressPercent = (completedWashes / 10) * 100;

              return (
                <div key={customer.id} className="bg-gray-800 rounded-lg shadow-2xl p-6 border border-purple-500/30">
                  <div className="flex items-start justify-between mb-4 pb-4 border-b border-gray-700">
                    <div className="flex-1">
                      <h3 className="text-xl font-bold text-purple-400">{customer.name}</h3>
                      <p className="text-gray-300 flex items-center gap-2 mt-1">
                        <Phone size={16} /> {customer.phone}
                      </p>
                      {customer.address && (
                        <div className="flex items-center gap-2 mt-1">
                          <MapPin size={16} className="text-gray-400" />
                          <span className="text-gray-300">{customer.address}</span>
                          <a
                            href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(customer.address)}`}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs flex items-center gap-1 transition shadow-lg"
                          >
                            ğŸ—ºï¸ Navigate
                          </a>
                        </div>
                      )}
                      <p className="text-gray-300 flex items-center gap-2 mt-1">
                        <Calendar size={16} /> Started: {customer.startDate}
                      </p>
                    </div>
                    <div className="text-right">
                      <div className="bg-purple-600 text-white px-4 py-2 rounded-lg font-bold shadow-lg mb-2">
                        â‚¹{customer.plan}/-
                      </div>
                      <div className="text-sm text-gray-300 mb-2">
                        {completedWashes}/10 Washes
                      </div>
                      <button
                        onClick={() => deleteCustomer(customer.id)}
                        className="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs transition shadow-lg"
                      >
                        Delete
                      </button>
                    </div>
                  </div>

                  <div className="mb-4">
                    <div className="flex justify-between text-sm text-gray-300 mb-2">
                      <span>Completion Progress</span>
                      <span className="font-semibold">{progressPercent.toFixed(0)}%</span>
                    </div>
                    <div className="w-full bg-gray-700 rounded-full h-3">
                      <div
                        className="bg-gradient-to-r from-purple-500 to-blue-500 h-3 rounded-full transition-all duration-500 shadow-lg"
                        style={{ width: `${progressPercent}%` }}
                      />
                    </div>
                  </div>

                  <div className="grid grid-cols-2 sm:grid-cols-5 gap-3">
                    {customer.washes.map(wash => (
                      <div key={wash.washNumber} className="border border-gray-600 rounded-lg p-3 bg-gray-700/50">
                        <div className="text-center mb-2">
                          <span className="font-bold text-purple-300">Wash #{wash.washNumber}</span>
                        </div>
                        
                        <div className={`${getStatusColor(wash.status)} px-2 py-1 rounded text-xs text-center mb-2 font-semibold`}>
                          {wash.status.toUpperCase()}
                        </div>

                        {wash.status === 'pending' && (
                          <button
                            onClick={() => updateWashStatus(customer.id, wash.washNumber, 'picked-up', 'pickup')}
                            className="w-full bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs flex items-center justify-center gap-1 transition shadow-lg"
                          >
                            <Truck size={12} /> Pickup
                          </button>
                        )}

                        {wash.status === 'picked-up' && (
                          <>
                            <div 
                              onClick={() => {
                                navigator.clipboard.writeText(wash.pickupCode);
                                setCopiedCode(wash.pickupCode);
                                setTimeout(() => setCopiedCode(null), 2000);
                              }}
                              className="text-xs bg-blue-600 text-white px-2 py-1 rounded font-bold mb-1 cursor-pointer hover:bg-blue-700 transition flex items-center justify-center gap-1"
                              title="Click to copy"
                            >
                              ğŸ“¦ #{wash.pickupCode} <Copy size={10} />
                            </div>
                            {wash.pickupDate && (
                              <div className="text-xs text-gray-300 mb-1">
                                ğŸ“… {wash.pickupDate}
                              </div>
                            )}
                            <button
                              onClick={() => updateWashStatus(customer.id, wash.washNumber, 'delivered', 'delivery')}
                              className="w-full bg-green-600 hover:bg-green-700 text-white px-2 py-1 rounded text-xs flex items-center justify-center gap-1 transition shadow-lg"
                            >
                              <CheckCircle size={12} /> Deliver
                            </button>
                          </>
                        )}

                        {wash.status === 'delivered' && (
                          <div className="text-xs text-gray-300 space-y-1">
                            <div 
                              onClick={() => {
                                navigator.clipboard.writeText(wash.pickupCode);
                                setCopiedCode(wash.pickupCode);
                                setTimeout(() => setCopiedCode(null), 2000);
                              }}
                              className="bg-blue-600 text-white px-2 py-1 rounded font-bold cursor-pointer hover:bg-blue-700 transition flex items-center justify-center gap-1"
                              title="Click to copy"
                            >
                              ğŸ“¦ #{wash.pickupCode} <Copy size={10} />
                            </div>
                            {wash.pickupDate && <div>ğŸ“… {wash.pickupDate}</div>}
                            <div 
                              onClick={() => {
                                navigator.clipboard.writeText(wash.deliveryCode);
                                setCopiedCode(wash.deliveryCode);
                                setTimeout(() => setCopiedCode(null), 2000);
                              }}
                              className="bg-green-600 text-white px-2 py-1 rounded font-bold mt-2 cursor-pointer hover:bg-green-700 transition flex items-center justify-center gap-1"
                              title="Click to copy"
                            >
                              âœ… #{wash.deliveryCode} <Copy size={10} />
                            </div>
                            {wash.deliveryDate && <div>ğŸ“… {wash.deliveryDate}</div>}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>

                  {completedWashes === 10 && (
                    <div className="mt-4 bg-gradient-to-r from-green-600 to-blue-600 text-white px-4 py-3 rounded-lg text-center font-bold shadow-lg">
                      ğŸ‰ All 10 Washes Completed! ğŸ‰
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
}
